<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=600, height=600">
<title>Noise Cancellation – 1 Component</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    width: 600px;
    height: 600px;
    overflow: hidden;
    font-family: 'Segoe UI', system-ui, sans-serif;
    background: #f2f2f5;
    color: #333;
    display: flex;
    flex-direction: column;
  }

  /* ===== WAVEFORM DISPLAY (upper region) ===== */
  #display-area {
    width: 600px;
    height: 360px;
    display: flex;
    flex-direction: column;
    padding: 6px 10px 0 10px;
    gap: 4px;
    background: #f2f2f5;
  }

  .wave-panel {
    flex: 1;
    position: relative;
    background: #ffffff;
    border: 1px solid #d8d8e0;
    border-radius: 6px;
    overflow: hidden;
  }

  .wave-panel canvas {
    display: block;
    width: 100%;
    height: 100%;
  }

  .wave-label {
    position: absolute;
    top: 4px;
    left: 8px;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    pointer-events: none;
  }

  /* Success message */
  #success-msg {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 13px;
    font-weight: 700;
    color: #22a860;
    letter-spacing: 1px;
    opacity: 0;
    transition: opacity 0.4s;
    pointer-events: none;
    background: rgba(255,255,255,0.85);
    padding: 4px 14px;
    border-radius: 4px;
  }

  /* ===== DIVIDER ===== */
  #divider {
    height: 2px;
    background: #d8d8e0;
    flex-shrink: 0;
  }

  /* ===== CONTROLS (lower region) ===== */
  #controls-area {
    flex: 1;
    padding: 12px 20px 10px 20px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    background: #eaeaef;
    overflow-y: auto;
  }

  #controls-header {
    font-size: 12px;
    font-weight: 700;
    color: #888;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    margin-bottom: 2px;
  }

  .component-bank {
    background: #ffffff;
    border: 1px solid #d8d8e0;
    border-radius: 8px;
    padding: 12px 16px;
  }
  .bank-title {
    font-size: 11px;
    font-weight: 700;
    color: #4a80c4;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 10px;
  }

  .slider-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
  }
  .slider-row:last-child { margin-bottom: 0; }

  .slider-label {
    width: 78px;
    font-size: 12px;
    color: #777;
    flex-shrink: 0;
  }

  input[type="range"] {
    flex: 1;
    height: 6px;
    -webkit-appearance: none;
    appearance: none;
    background: #d8d8e0;
    border-radius: 3px;
    outline: none;
  }
  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: #4a80c4;
    cursor: pointer;
    border: 2px solid #fff;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
  }
  input[type="range"]::-moz-range-thumb {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: #4a80c4;
    cursor: pointer;
    border: 2px solid #fff;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
  }

  .slider-value {
    width: 58px;
    text-align: right;
    font-size: 12px;
    font-variant-numeric: tabular-nums;
    color: #555;
    flex-shrink: 0;
  }

  #reset-btn {
    align-self: flex-end;
    margin-top: auto;
    padding: 6px 18px;
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 0.5px;
    color: #777;
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 5px;
    cursor: pointer;
    transition: background 0.2s;
  }
  #reset-btn:hover { background: #e8e8ee; color: #333; }
</style>
</head>
<body>

<!-- ===== DISPLAY ===== -->
<div id="display-area">

  <!-- Panel 1: Target -->
  <div class="wave-panel" id="panel-target">
    <canvas id="canvasTarget"></canvas>
    <div class="wave-label" style="color:#d04040;">Target Noise</div>
  </div>

  <!-- Panel 2: User's cancellation wave -->
  <div class="wave-panel" id="panel-user">
    <canvas id="canvasUser"></canvas>
    <div class="wave-label" style="color:#4a80c4;">Your Wave</div>
  </div>

  <!-- Panel 3: Combined result -->
  <div class="wave-panel" id="panel-combined">
    <canvas id="canvasCombined"></canvas>
    <div class="wave-label" style="color:#22a860;">Result</div>
    <div id="success-msg">✓ NOISE CANCELLED</div>
  </div>

</div>

<div id="divider"></div>

<!-- ===== CONTROLS ===== -->
<div id="controls-area">
  <div id="controls-header">Your Cancellation Wave</div>

  <div class="component-bank" id="bank-1">
    <div class="bank-title">Component 1</div>

    <div class="slider-row">
      <span class="slider-label">Amplitude</span>
      <input type="range" id="amp1" min="0" max="20" step="1" value="0">
      <span class="slider-value" id="amp1-val">0 μm</span>
    </div>

    <div class="slider-row">
      <span class="slider-label">Frequency</span>
      <input type="range" id="freq1" min="0" max="500" step="50" value="50">
      <span class="slider-value" id="freq1-val">50 Hz</span>
    </div>

    <div class="slider-row">
      <span class="slider-label">Phase</span>
      <input type="range" id="phase1" min="0" max="360" step="5" value="0">
      <span class="slider-value" id="phase1-val">0°</span>
    </div>
  </div>

  <!-- Future: bank-2, bank-3 inserted here -->

  <button id="reset-btn">Reset Sliders</button>
</div>

<script>
// ============================================================
//  BACK-END CONFIGURATION
// ============================================================
// Converts display Hz to visual frequency for the wave equation
const FREQ_SCALE = 0.01; // 500 Hz on slider → 5.0 visual freq

const TARGET_COMPONENTS = [
  { amp: 10, freq: 200 * FREQ_SCALE, phase: 0 }
];

// ============================================================
//  CANVAS SETUP
// ============================================================
const canvases = {
  target:   document.getElementById('canvasTarget'),
  user:     document.getElementById('canvasUser'),
  combined: document.getElementById('canvasCombined')
};

function sizeCanvases() {
  for (const key in canvases) {
    const cvs = canvases[key];
    const panel = cvs.parentElement;
    cvs.width  = panel.clientWidth;
    cvs.height = panel.clientHeight;
  }
}
sizeCanvases();

const TIME_WINDOW = 4;
const PAD_X = 6;

// ============================================================
//  SLIDER REFERENCES
// ============================================================
const amp1Slider   = document.getElementById('amp1');
const freq1Slider  = document.getElementById('freq1');
const phase1Slider = document.getElementById('phase1');
const amp1Val   = document.getElementById('amp1-val');
const freq1Val  = document.getElementById('freq1-val');
const phase1Val = document.getElementById('phase1-val');

const successMsg = document.getElementById('success-msg');

amp1Slider.addEventListener('input',   () => { amp1Val.textContent   = amp1Slider.value + ' μm'; });
freq1Slider.addEventListener('input',  () => { freq1Val.textContent  = freq1Slider.value + ' Hz'; });
phase1Slider.addEventListener('input', () => { phase1Val.textContent = phase1Slider.value + '°'; });

document.getElementById('reset-btn').addEventListener('click', () => {
  amp1Slider.value = 0;   amp1Val.textContent = '0 μm';
  freq1Slider.value = 50;  freq1Val.textContent = '50 Hz';
  phase1Slider.value = 0; phase1Val.textContent = '0°';
});

// ============================================================
//  WAVE MATH
// ============================================================
function degToRad(deg) { return deg * Math.PI / 180; }

function targetAt(t) {
  let y = 0;
  for (const c of TARGET_COMPONENTS) {
    y += c.amp * Math.sin(2 * Math.PI * c.freq * t + degToRad(c.phase));
  }
  return y;
}

function userAt(t, userComps) {
  let y = 0;
  for (const c of userComps) {
    y += c.amp * Math.sin(2 * Math.PI * c.freq * t + degToRad(c.phase));
  }
  return y;
}

function getUserComponents() {
  return [
    {
      amp:   parseFloat(amp1Slider.value),
      freq:  parseFloat(freq1Slider.value) * FREQ_SCALE,
      phase: parseFloat(phase1Slider.value)
    }
  ];
}

// ============================================================
//  DRAWING
// ============================================================
function drawGrid(ctx, w, h) {
  const cy = h / 2;
  ctx.strokeStyle = '#d0d0d8';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(PAD_X, cy);
  ctx.lineTo(w - PAD_X, cy);
  ctx.stroke();

  ctx.strokeStyle = '#ececf0';
  ctx.setLineDash([3, 5]);
  const quarter = (h / 2 - 8) * 0.5;
  for (const sign of [-1, 1]) {
    ctx.beginPath();
    ctx.moveTo(PAD_X, cy + sign * quarter);
    ctx.lineTo(w - PAD_X, cy + sign * quarter);
    ctx.stroke();
  }
  ctx.setLineDash([]);
}

// Maximum amplitude value for scaling (matches slider max)
const AMP_SCALE = 20;

function drawWaveOnCanvas(cvs, evalFn, color, lineWidth) {
  const ctx = cvs.getContext('2d');
  const w = cvs.width;
  const h = cvs.height;
  const cy = h / 2;
  const maxAmpPx = (h / 2) - 8;
  const drawW = w - PAD_X * 2;

  ctx.strokeStyle = color;
  ctx.lineWidth = lineWidth;
  ctx.beginPath();
  for (let px = 0; px <= drawW; px++) {
    const t = (px / drawW) * TIME_WINDOW;
    const y = evalFn(t) / AMP_SCALE; // normalize so ±AMP_SCALE fills the panel
    const canvasY = cy - y * maxAmpPx;
    if (px === 0) ctx.moveTo(PAD_X + px, canvasY);
    else ctx.lineTo(PAD_X + px, canvasY);
  }
  ctx.stroke();
}

// Target RMS for normalization
const targetRMS = (() => {
  let sumSq = 0;
  const N = 400;
  for (let i = 0; i < N; i++) {
    const t = (i / N) * TIME_WINDOW;
    const v = targetAt(t);
    sumSq += v * v;
  }
  return Math.sqrt(sumSq / N);
})();

function computeResidualRMS(userComps) {
  let sumSq = 0;
  const N = 400;
  for (let i = 0; i < N; i++) {
    const t = (i / N) * TIME_WINDOW;
    const combined = targetAt(t) + userAt(t, userComps);
    sumSq += combined * combined;
  }
  return Math.sqrt(sumSq / N);
}

// ============================================================
//  ANIMATION LOOP
// ============================================================
function frame() {
  const userComps = getUserComponents();

  // --- Target panel ---
  const ctxT = canvases.target.getContext('2d');
  ctxT.clearRect(0, 0, canvases.target.width, canvases.target.height);
  drawGrid(ctxT, canvases.target.width, canvases.target.height);
  drawWaveOnCanvas(canvases.target, t => targetAt(t), '#d04040', 2.5);

  // --- User panel ---
  const ctxU = canvases.user.getContext('2d');
  ctxU.clearRect(0, 0, canvases.user.width, canvases.user.height);
  drawGrid(ctxU, canvases.user.width, canvases.user.height);
  drawWaveOnCanvas(canvases.user, t => userAt(t, userComps), '#4a80c4', 2.5);

  // --- Combined panel ---
  const ctxC = canvases.combined.getContext('2d');
  ctxC.clearRect(0, 0, canvases.combined.width, canvases.combined.height);
  drawGrid(ctxC, canvases.combined.width, canvases.combined.height);
  drawWaveOnCanvas(canvases.combined, t => targetAt(t) + userAt(t, userComps), '#22a860', 2.5);

  // --- Residual check for success message ---
  const rms = computeResidualRMS(userComps);
  const normalizedRMS = Math.min(rms / (targetRMS || 1), 2);
  successMsg.style.opacity = normalizedRMS < 0.03 ? '1' : '0';

  requestAnimationFrame(frame);
}

requestAnimationFrame(frame);
</script>
</body>
</html>
